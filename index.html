<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>خريطة حفر الباطن عالية الدقة</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html, body {
    height: 100%;
    margin: 0;
    background: #000;
    font-family: "TheSansArabic", sans-serif;
  }
  #map {
    height: 100%;
    width: 100%;
  }
  .leaflet-popup-content {
    text-align: center;
    direction: rtl;
    font-size: 14px;
  }
</style>
</head>

<body>
<div id="map"></div>

<script>
  // === Initialize map centered on Hafar Al-Batin ===
  const map = L.map("map", {
    center: [28.4322, 45.9708],
    zoom: 13,
    minZoom: 10,
    maxZoom: 22,
    zoomControl: true,
  });

  // === ESRI World Imagery (High-Resolution Satellite) ===
  const esriSatellite = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    {
      maxZoom: 22,
      attribution: "© Esri, Maxar, Earthstar Geographics",
    }
  ).addTo(map);

  // === ESRI Label Layer (shows street names, places, buildings) ===
  const esriLabels = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
    {
      maxZoom: 22,
      opacity: 1,
      attribution: "© Esri",
    }
  ).addTo(map);

  // === Marker handling ===
  let markers = [];
  // <CHANGE> Changed from single selectedMarker to Set of selectedMarkers for multiple selections
  let selectedMarkers = new Set();
  const nameToMarker = new Map();
  const nameToData = new Map();
  let pendingSelections = [];

  function resetMarkerStyle(marker) {
    marker.setStyle({
      color: "#ff0000",
      fillColor: "#ff0000",
      radius: 8,
    });
  }

  function highlightMarker(marker) {
    marker.setStyle({
      color: "#ffff00",
      fillColor: "#ffff00",
      radius: 11,
    });
  }

  function buildPopupHtml(regionName, data) {
    const access = data?.access ?? "-";
    const satisfaction = data?.satisfaction ?? "-";
    return `<div>
      <b>${regionName}</b><br/>
      امكانية الوصول: ${access}<br/>
      رضا السكان: ${satisfaction}
    </div>`;
  }

  // <CHANGE> Updated to handle multiple region names
  function highlightRegionsByNames(regionNames, openPopup = true) {
    if (!regionNames || regionNames.length === 0) return;

    // Reset all previously selected markers
    selectedMarkers.forEach((marker) => {
      resetMarkerStyle(marker);
    });
    selectedMarkers.clear();

    // Highlight all new selected regions
    regionNames.forEach((regionName) => {
      if (!regionName) return;
      
      const marker = nameToMarker.get(regionName);
      if (!marker) {
        // Defer until markers arrive
        pendingSelections.push(regionName);
        return;
      }

      highlightMarker(marker);
      selectedMarkers.add(marker);

      if (openPopup) {
        const data = nameToData.get(regionName);
        marker.bindPopup(buildPopupHtml(regionName, data), { autoPan: false });
      }
    });

    // Open popup for the first selected marker
    if (openPopup && selectedMarkers.size > 0) {
      const firstMarker = Array.from(selectedMarkers)[0];
      firstMarker.openPopup();
    }
  }

  // --- Receive data and selection from Grafana ---
  window.addEventListener("message", (event) => {
    const msg = event.data;
    if (!msg) return;

    // Initial/updated dataset
    if (msg.type === "habData") {
      markers.forEach((m) => map.removeLayer(m));
      markers = [];
      nameToMarker.clear();
      nameToData.clear();
      selectedMarkers.clear();

      const regionData = msg.data || [];
      if (!regionData.length) return;

      regionData.forEach((r) => {
        const regionNameDecoded = decodeURIComponent(r.name);
        const marker = L.circleMarker([r.lat, r.long], {
          radius: 8,
          color: "#ff0000",
          fillColor: "#ff0000",
          fillOpacity: 0.9,
          weight: 1.5,
        })
          .addTo(map)
          .bindPopup(buildPopupHtml(regionNameDecoded, r))
          .on("click", () => {
            // <CHANGE> When user clicks a marker, send single selection back to Grafana
            // Reset all selections and highlight only the clicked marker
            selectedMarkers.forEach((m) => {
              resetMarkerStyle(m);
            });
            selectedMarkers.clear();

            highlightMarker(marker);
            selectedMarkers.add(marker);

            window.parent.postMessage(
              {
                type: "mapClick",
                region: regionNameDecoded, // plain text
              },
              "*"
            );
          });

        nameToMarker.set(regionNameDecoded, marker);
        nameToData.set(regionNameDecoded, r);
        markers.push(marker);
      });

      if (regionData.length > 1) {
        const bounds = L.latLngBounds(regionData.map((r) => [r.lat, r.long]));
        map.fitBounds(bounds, { padding: [40, 40] });
      }

      // <CHANGE> If selections arrived earlier, apply now
      if (pendingSelections.length > 0) {
        const names = pendingSelections;
        pendingSelections = [];
        highlightRegionsByNames(names, true);
      }

      return;
    }

    // <CHANGE> Programmatic selection from Grafana - now handles both single and multiple selections
    if (msg.type === "selectRegion") {
      // msg.region can be a single string or an array of strings
      let regionNames = [];
      
      if (Array.isArray(msg.region)) {
        regionNames = msg.region;
      } else if (typeof msg.region === "string") {
        regionNames = [msg.region];
      }

      highlightRegionsByNames(regionNames, true);
      return;
    }
  });
</script>
</body>
</html>
