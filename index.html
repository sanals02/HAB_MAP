<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>خريطة حفر الباطن عالية الدقة</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  html, body { height: 100%; margin: 0; background: #000; font-family: "TheSansArabic", sans-serif; }
  #map { height: 100%; width: 100%; }
  .leaflet-popup-content { text-align: center; direction: rtl; font-size: 14px; }
  .selected-tooltip {
    background: rgba(0,0,0,0.85);
    color: #fff;
    border: 1px solid #ff0;
    padding: 6px 8px;
    border-radius: 4px;
    text-align: center;
    direction: rtl;
    font-size: 13px;
  }
</style>
</head>
<body>
<div id="map"></div>
<script>
  const map = L.map("map", {
    center: [28.4322, 45.9708],
    zoom: 13,
    minZoom: 10,
    maxZoom: 22,
    zoomControl: true,
  });
  L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 22, attribution: "© Esri, Maxar, Earthstar Geographics" }
  ).addTo(map);
  L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 22, attribution: "© Esri" }
  ).addTo(map);

  let markers = [];
  const nameToMarker = new Map();
  const nameToData = new Map();
  let multiSelection = new Set();
  let pendingMultiSelection = null;

  function styleDefault(marker) {
    marker.setStyle({ color: "#ff0000", fillColor: "#ff0000", radius: 8 });
    if (marker._tooltip) marker.closeTooltip();
  }
  function styleSelected(marker, infoHtml) {
    marker.setStyle({ color: "#ffff00", fillColor: "#ffff00", radius: 11 });
    marker.bindTooltip(infoHtml, { permanent: true, direction: "top", className: "selected-tooltip" }).openTooltip();
  }
  function buildInfoHtml(name, data) {
    return `<div>
      <b>${name}</b><br/>
      امكانية الوصول: ${data?.access ?? "-"}<br/>
      رضا السكان: ${data?.satisfaction ?? "-"}
    </div>`;
  }
  function updateAllVisuals() {
    nameToMarker.forEach((marker, name) => {
      if (multiSelection.has(name)) {
        styleSelected(marker, buildInfoHtml(name, nameToData.get(name)));
      } else {
        styleDefault(marker);
      }
    });
  }
  function clearAll() {
    multiSelection.clear();
    updateAllVisuals();
  }
  function selectRegions(arr) {
    multiSelection = new Set(arr.filter(Boolean).map(v => v.trim()));
    updateAllVisuals();
  }

  window.addEventListener("message", (event) => {
    const msg = event.data;
    if (!msg) return;
    if (msg.type === "habData") {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      nameToMarker.clear();
      nameToData.clear();
      clearAll();
      pendingMultiSelection = null;
      const regionData = msg.data || [];
      if (!regionData.length) return;
      regionData.forEach((r) => {
        const name = decodeURIComponent(r.name);
        const marker = L.circleMarker([r.lat, r.long], {
          radius: 8, color: "#ff0000", fillColor: "#ff0000", fillOpacity: 0.9, weight: 1.5,
        }).addTo(map)
        .bindPopup(buildInfoHtml(name, r))
        .on("click", () => {
          window.parent.postMessage({ type: "mapClick", region: name }, "*");
        });
        nameToMarker.set(name, marker);
        nameToData.set(name, r);
        markers.push(marker);
      });
      if (regionData.length > 1) {
        const bounds = L.latLngBounds(regionData.map((r) => [r.lat, r.long]));
        map.fitBounds(bounds, { padding: [40, 40] });
      }
      // Handle deferred selection
      if (pendingMultiSelection) selectRegions(pendingMultiSelection);
      return;
    }
    if (msg.type === "selectRegions") {
      // multi-select: expect msg.regions as array
      if (!Array.isArray(msg.regions)) {
        pendingMultiSelection = [msg.regions].filter(Boolean);
        return;
      }
      if (!nameToMarker.size) { pendingMultiSelection = msg.regions.slice(); return; }
      selectRegions(msg.regions);
      return;
    }
    if (msg.type === "selectRegion") {
      // single-select API for compatibility: mark only that point
      if (!msg.region || !nameToMarker.size) { pendingMultiSelection = [msg.region]; return; }
      selectRegions([msg.region]);
      return;
    }
    if (msg.type === "clearSelection") {
      clearAll();
      return;
    }
  });
</script>
</body>
</html>
