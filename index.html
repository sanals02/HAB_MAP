<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>خريطة حفر الباطن عالية الدقة</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html, body {
    height: 100%;
    margin: 0;
    background: #000;
    font-family: "TheSansArabic", sans-serif;
  }
  #map {
    height: 100%;
    width: 100%;
  }
  .leaflet-popup-content {
    text-align: center;
    direction: rtl;
    font-size: 14px;
  }
  .selected-tooltip {
    background: rgba(0,0,0,0.85);
    color: #fff;
    border: 1px solid #ff0;
    padding: 6px 8px;
    border-radius: 4px;
    text-align: center;
    direction: rtl;
    font-size: 13px;
  }
</style>
</head>

<body>
<div id="map"></div>

<script>
  const map = L.map("map", {
    center: [28.4322, 45.9708],
    zoom: 13,
    minZoom: 10,
    maxZoom: 22,
    zoomControl: true,
  });

  L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 22, attribution: "© Esri, Maxar, Earthstar Geographics" }
  ).addTo(map);

  L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 22, opacity: 1, attribution: "© Esri" }
  ).addTo(map);

  // Marker bookkeeping
  let markers = [];
  const nameToMarker = new Map();
  const nameToData = new Map();
  const selectedNames = new Set(); // multi-selected by parent
  let pendingSelection = null;     // array of names received before markers exist

  function setMarkerDefaultStyle(marker) {
    marker.setStyle({ color: "#ff0000", fillColor: "#ff0000", radius: 8 });
  }

  function setMarkerSelectedStyle(marker) {
    marker.setStyle({ color: "#ffff00", fillColor: "#ffff00", radius: 11 });
  }

  function buildInfoHtml(regionName, data) {
    const access = data?.access ?? "-";
    const satisfaction = data?.satisfaction ?? "-";
    return `<div>
      <b>${regionName}</b><br/>
      امكانية الوصول: ${access}<br/>
      رضا السكان: ${satisfaction}
    </div>`;
  }

  function applySelectionVisuals() {
    // Reset all
    nameToMarker.forEach((marker) => {
      setMarkerDefaultStyle(marker);
      if (marker.isTooltipOpen && marker.isTooltipOpen()) {
        marker.closeTooltip();
      }
    });

    // Apply selected
    selectedNames.forEach((name) => {
      const marker = nameToMarker.get(name);
      if (!marker) return;
      setMarkerSelectedStyle(marker);
      const data = nameToData.get(name);
      const html = buildInfoHtml(name, data);
      marker.bindTooltip(html, { permanent: true, direction: "top", className: "selected-tooltip" }).openTooltip();
    });
  }

  function clearAllSelections() {
    selectedNames.clear();
    applySelectionVisuals();
  }

  function selectRegionsByNames(namesArray) {
    if (!Array.isArray(namesArray) || namesArray.length === 0) {
      clearAllSelections();
      return;
    }
    selectedNames.clear();
    namesArray.forEach((n) => {
      if (typeof n === "string" && n.trim()) selectedNames.add(n.trim());
    });
    applySelectionVisuals();
  }

  window.addEventListener("message", (event) => {
    const msg = event.data;
    if (!msg) return;

    if (msg.type === "habData") {
      // Rebuild markers
      markers.forEach((m) => map.removeLayer(m));
      markers = [];
      nameToMarker.clear();
      nameToData.clear();
      clearAllSelections();
      pendingSelection = null;

      const regionData = msg.data || [];
      if (!regionData.length) return;

      regionData.forEach((r) => {
        const name = decodeURIComponent(r.name);
        const marker = L.circleMarker([r.lat, r.long], {
          radius: 8,
          color: "#ff0000",
          fillColor: "#ff0000",
          fillOpacity: 0.9,
          weight: 1.5,
        })
          .addTo(map)
          .bindPopup(buildInfoHtml(name, r))
          .on("click", () => {
            // Clicking a marker emits a single-region selection upstream
            window.parent.postMessage({ type: "mapClick", region: name }, "*");
          });

        nameToMarker.set(name, marker);
        nameToData.set(name, r);
        markers.push(marker);
      });

      if (regionData.length > 1) {
        const bounds = L.latLngBounds(regionData.map((r) => [r.lat, r.long]));
        map.fitBounds(bounds, { padding: [40, 40] });
      }

      if (pendingSelection) {
        const arr = pendingSelection;
        pendingSelection = null;
        selectRegionsByNames(arr);
      }
      return;
    }

    if (msg.type === "selectRegions") {
      // Expect msg.regions as array of names
      if (!Array.isArray(msg.regions)) {
        pendingSelection = [msg.regions].filter(Boolean);
        return;
      }
      if (nameToMarker.size === 0) {
        pendingSelection = msg.regions.slice();
        return;
      }
      selectRegionsByNames(msg.regions);
      return;
    }

    if (msg.type === "clearSelection") {
      clearAllSelections();
      return;
    }
  });
</script>
</body>
</html>
